name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: Calculate next version
        id: version
        run: |
          LATEST=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest=$LATEST"
          MAJOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f1)
          MINOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f2)
          PATCH=$(echo "$LATEST" | sed 's/v//' | cut -d. -f3)
          NEXT="v${MAJOR}.$((MINOR + 1)).${PATCH}"
          echo "next=$NEXT" >> "$GITHUB_OUTPUT"
          echo "Next version: $NEXT"

      - name: Cross build
        run: |
          VERSION=${{ steps.version.outputs.next }}
          LDFLAGS="-X github.com/Koutaro-Hanabusa/mangrove/command.Version=${VERSION}"
          mkdir -p dist

          GOOS=linux  GOARCH=amd64 go build -ldflags "$LDFLAGS" -o dist/mgv-linux-amd64  ./cmd/mgv
          GOOS=linux  GOARCH=arm64 go build -ldflags "$LDFLAGS" -o dist/mgv-linux-arm64  ./cmd/mgv
          GOOS=darwin GOARCH=amd64 go build -ldflags "$LDFLAGS" -o dist/mgv-darwin-amd64 ./cmd/mgv
          GOOS=darwin GOARCH=arm64 go build -ldflags "$LDFLAGS" -o dist/mgv-darwin-arm64 ./cmd/mgv

      - name: Create tag
        run: |
          VERSION=${{ steps.version.outputs.next }}
          git tag "$VERSION"
          git push origin "$VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.next }}
          generate_release_notes: true
          files: dist/*
